<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - Книжный магазин</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-xl">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <a href="index.html" class="text-2xl font-bold flex items-center">
                    <i class="fas fa-book-open mr-2"></i>
                    Книжный мир
                </a>
                <div class="flex items-center space-x-6">
                    <a href="index.html" class="hover:text-blue-200 font-semibold">
                        <i class="fas fa-home mr-1"></i>Главная
                    </a>
                    <a href="profile.html" class="hover:text-blue-200 font-semibold">
                        <i class="fas fa-user mr-1"></i>Профиль
                    </a>
                    <a href="login.html" class="hover:text-blue-200 font-semibold" id="authLink">
                        <i class="fas fa-sign-in-alt mr-1"></i>Войти
                    </a>
                    <div id="adminLink" class="hidden">
                        <a href="admin.html" class="hover:text-blue-200 font-semibold">
                            <i class="fas fa-cog mr-1"></i>Админка
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Admin Content -->
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8 text-gray-800">
            <i class="fas fa-cog mr-3 text-blue-600"></i>Панель администратора
        </h1>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                <div class="text-3xl font-bold text-blue-600 mb-2" id="statsBooks">0</div>
                <div class="text-gray-600">Всего книг</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                <div class="text-3xl font-bold text-green-600 mb-2" id="statsUsers">0</div>
                <div class="text-gray-600">Пользователей</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                <div class="text-3xl font-bold text-purple-600 mb-2" id="statsTransactions">0</div>
                <div class="text-gray-600">Транзакций</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                <div class="text-3xl font-bold text-orange-600 mb-2" id="statsRevenue">0</div>
                <div class="text-gray-600">Выручка (₽)</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-lg mb-8">
            <div class="flex border-b">
                <button class="tab-btn py-4 px-6 font-semibold border-b-2 border-blue-600 text-blue-600" onclick="switchTab('books')">
                    Управление книгами
                </button>
                <button class="tab-btn py-4 px-6 font-semibold text-gray-600" onclick="switchTab('transactions')">
                    Транзакции
                </button>
                <button class="tab-btn py-4 px-6 font-semibold text-gray-600" onclick="switchTab('overdue')">
                    Просрочки
                </button>
            </div>
        </div>

        <!-- Books Tab -->
        <div id="booksTab" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-6">Добавить новую книгу</h2>
                <form id="addBookForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Название</label>
                        <input type="text" name="title" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Автор</label>
                        <input type="text" name="author" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Год</label>
                        <input type="number" name="year" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Категория</label>
                        <select name="category" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="Фэнтези">Фэнтези</option>
                            <option value="Научная фантастика">Научная фантастика</option>
                            <option value="Роман">Роман</option>
                            <option value="Детектив">Детектив</option>
                            <option value="Ужасы">Ужасы</option>
                            <option value="Приключения">Приключения</option>
                            <option value="Исторический">Исторический</option>
                            <option value="Биография">Биография</option>
                            <option value="Поэзия">Поэзия</option>
                            <option value="Драма">Драма</option>
                            <option value="Комиксы">Комиксы</option>
                            <option value="ЛитРПГ">ЛитРПГ</option>
                            <option value="Другое">Другое</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Цена покупки (₽)</label>
                        <input type="number" name="price" required step="0.01" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Цена аренды (₽/мес)</label>
                        <input type="number" name="rentalPrice" required step="0.01" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Описание</label>
                        <textarea name="description" required rows="4" class="w-full px-4 py-2 border rounded-lg"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Обложка (URL)</label>
                        <input type="url" name="coverImage" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                            Добавить книгу
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6">Список книг</h2>
                <div id="booksList">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-500">Загрузка книг...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactionsTab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6">История транзакций</h2>
                <div class="flex space-x-4 mb-6">
                    <select id="transactionsFilter" class="px-4 py-2 border rounded-lg" onchange="loadTransactions()">
                        <option value="all">Все статусы</option>
                        <option value="completed">Завершённые</option>
                        <option value="active rental">Активные аренды</option>
                        <option value="overdue">Просроченные</option>
                    </select>
                    <select id="transactionsType" class="px-4 py-2 border rounded-lg" onchange="loadTransactions()">
                        <option value="all">Все типы</option>
                        <option value="purchase">Покупки</option>
                        <option value="rental">Аренды</option>
                    </select>
                </div>
                <div id="transactionsList">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-500">Загрузка транзакций...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overdue Tab -->
        <div id="overdueTab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6">Просроченные аренды</h2>
                <div id="overdueList">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
                        <p class="text-gray-500">Загрузка просрочек...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadAdminData() {
            if (!checkAuth()) return;

            try {
                // Load stats
                const statsResponse = await fetch('/api/admin/stats', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                const stats = await statsResponse.json();
                
                document.getElementById('statsBooks').textContent = stats.totalBooks;
                document.getElementById('statsUsers').textContent = stats.totalUsers;
                document.getElementById('statsTransactions').textContent = stats.totalTransactions;
                document.getElementById('statsRevenue').textContent = stats.totalRevenue;

                // Load books
                await loadBooks();
                
                // Load transactions
                await loadTransactions();
                
                // Load overdue
                await loadOverdue();

            } catch (error) {
                console.error('Error loading admin data:', error);
                if (error.message === 'Token is not valid' || error.message.includes('Admin rights')) {
                    alert('Доступ запрещен. Требуются права администратора.');
                    window.location.href = 'index.html';
                }
            }
        }

        async function loadBooks() {
            try {
                const response = await fetch('/api/books?limit=100');
                const data = await response.json();
                
                const booksList = document.getElementById('booksList');
                booksList.innerHTML = '';

                if (data.books.length === 0) {
                    booksList.innerHTML = '<p class="text-gray-500">Книги не найдены</p>';
                    return;
                }

                let html = '<div class="grid grid-cols-1 gap-4">';
                data.books.forEach(book => {
                    html += `
                        <div class="border rounded-lg p-4 flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold">${book.title}</h4>
                                <p class="text-gray-600">${book.author} • ${book.year}</p>
                                <span class="text-sm ${book.isAvailable ? 'text-green-600' : 'text-red-600'}">
                                    ${book.isAvailable ? 'Доступна' : 'Недоступна'}
                                </span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editBook('${book._id}')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteBook('${book._id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                booksList.innerHTML = html;

            } catch (error) {
                console.error('Error loading books:', error);
            }
        }

        async function loadTransactions() {
            try {
                const status = document.getElementById('transactionsFilter').value;
                const type = document.getElementById('transactionsType').value;
                
                const response = await fetch(`/api/admin/transactions?status=${status}&type=${type}&limit=50`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                const data = await response.json();

                const transactionsList = document.getElementById('transactionsList');
                transactionsList.innerHTML = '';

                if (data.transactions.length === 0) {
                    transactionsList.innerHTML = '<p class="text-gray-500">Транзакции не найдены</p>';
                    return;
                }

                let html = '<div class="grid grid-cols-1 gap-4">';
                data.transactions.forEach(transaction => {
                    html += `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-semibold">${transaction.bookId.title}</h4>
                                    <p class="text-gray-600">${transaction.bookId.author}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm ${
                                    transaction.status === 'completed' ? 'bg-green-100 text-green-800' :
                                    transaction.status === 'active rental' ? 'bg-blue-100 text-blue-800' :
                                    'bg-red-100 text-red-800'
                                }">
                                    ${transaction.type === 'purchase' ? 'Покупка' : 'Аренда'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Пользователь:</span>
                                    <div>${transaction.userId.username}</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Сумма:</span>
                                    <div class="font-semibold">${transaction.amount}₽</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Дата:</span>
                                    <div>${new Date(transaction.createdAt).toLocaleDateString('ru-RU')}</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Статус:</span>
                                    <div>${transaction.status === 'completed' ? 'Завершено' : 
                                           transaction.status === 'active rental' ? 'Активно' : 'Просрочено'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                transactionsList.innerHTML = html;

            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        async function loadOverdue() {
            try {
                const response = await fetch('/api/admin/overdue', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                const overdue = await response.json();

                const overdueList = document.getElementById('overdueList');
                overdueList.innerHTML = '';

                if (overdue.length === 0) {
                    overdueList.innerHTML = '<p class="text-gray-500">Просроченных аренд нет</p>';
                    return;
                }

                let html = '<div class="grid grid-cols-1 gap-4">';
                overdue.forEach(rental => {
                    const endDate = new Date(rental.rentalEndDate);
                    const daysOverdue = Math.floor((new Date() - endDate) / (1000 * 60 * 60 * 24));
                    
                    html += `
                        <div class="border rounded-lg p-4 bg-red-50">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-semibold">${rental.bookId.title}</h4>
                                    <p class="text-gray-600">${rental.bookId.author}</p>
                                </div>
                                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm">
                                    Просрочено на ${daysOverdue} дней
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Пользователь:</span>
                                    <div>${rental.userId.username} (${rental.userId.email})</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Должен был вернуть:</span>
                                    <div class="font-semibold">${endDate.toLocaleDateString('ru-RU')}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                overdueList.innerHTML = html;

            } catch (error) {
                console.error('Error loading overdue:', error);
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('text-gray-600');
            });
            event.target.classList.add('border-blue-600', 'text-blue-600');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
        }

        document.getElementById('addBookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const bookData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(bookData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Книга успешно добавлена!');
                    e.target.reset();
                    loadBooks();
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding book:', error);
                alert('Ошибка добавления книги');
            }
        });

        async function deleteBook(bookId) {
            if (!confirm('Вы уверены, что хотите удалить эту книгу?')) return;

            try {
                const response = await fetch('/api/books/' + bookId, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Книга успешно удалена!');
                    loadBooks();
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting book:', error);
                alert('Ошибка удаления книги');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthState();
            loadAdminData();
        });
    </script>
    <script src="js/auth.js"></script>
</body>
</html>